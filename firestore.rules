rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Fonction helper pour vérifier l'authentification
    function isAuthed() {
      return request.auth != null;
    }

    // Collection: users
    // Contient les informations des utilisateurs (nom, email, role, active, phone, photoUrl)
    match /users/{uid} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: roles
    // Contient les rôles et leurs permissions (name, description, permissions)
    match /roles/{roleId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: config
    // Contient la configuration globale (stockMax, etc.)
    // Ne peut pas être supprimée pour éviter la perte de données critiques
    match /config/{docId} {
      allow read: if isAuthed();
      allow create, update: if isAuthed();
      allow delete: if false;
    }

    // Collection: ressources
    // Contient les types de ressources (nom, prixVente, prixBourse, tailleObjet, createdAt)
    match /ressources/{resId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: ventes
    // Contient les ventes créées par les employés (dateVente, typeRessourceId, quantite, tailleObjet, employeId, prenom, nom, telephone, statut, createdAt)
    match /ventes/{saleId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: finance
    // Contient les transactions financières (type, montant, description, date)
    // Ne peut pas être modifiée ou supprimée pour garantir l'intégrité des données financières
    match /finance/{financeId} {
      allow read: if isAuthed();
      allow create: if isAuthed();
      allow update, delete: if false;
    }

    // Collection: logs
    // Contient les logs système (type, action, message, uid, createdAt)
    // Permet la suppression pour permettre le nettoyage des logs
    match /logs/{logId} {
      allow read: if isAuthed();
      allow create: if isAuthed();
      allow update: if false;
      allow delete: if isAuthed();
    }

    // Collection: flotte
    // Contient les véhicules de l'entreprise (type, modele, immatriculation, nombrePlaces, prixAchat, assuranceTier1-4, dateAchat, kilometrage, notes, createdAt)
    // Lecture pour tous les utilisateurs authentifiés (employés et entreprise)
    // Création, modification et suppression pour les utilisateurs authentifiés (espace entreprise)
    match /flotte/{vehiculeId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: ventesPointsIllegaux
    // Contient les ventes de points illégaux (dateVente, nomClient, points, prixUnitaire, montantTotal, vendeurId, statut, createdAt)
    match /ventesPointsIllegaux/{venteId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: ventesPacksArmes
    // Contient les ventes de packs d'armes (dateVente, nomClient, typePack, quantite, prixUnitaire, montantTotal, vendeurId, statut, createdAt)
    match /ventesPacksArmes/{venteId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: typesPointsIllegaux
    // Contient les types de points illégaux disponibles (nom, prixUnitaire, description, createdAt)
    match /typesPointsIllegaux/{typeId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: typesPacksArmes
    // Contient les types de packs d'armes disponibles (nom, prixUnitaire, description, createdAt)
    match /typesPacksArmes/{typeId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: centraleEffectif
    // Gère le suivi des équipes (affectations, véhicules, employés, statuts)
    match /centraleEffectif/{entryId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: centraleConfig
    // Stocke la configuration de la centrale (statuts personnalisés, etc.)
    match /centraleConfig/{configId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }

    // Collection: centraleServices
    // Suivi des prises de service des employés (statut en service)
    match /centraleServices/{serviceId} {
      allow read: if isAuthed();
      allow create, update, delete: if isAuthed();
    }
  }
}