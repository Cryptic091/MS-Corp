(async function() {
  function parseFrenchNumber(value) {
    if (!value || value === 'â€”' || value === '-' || value === '') return null;
    let cleaned = String(value).replace(/\s/g, '').replace(/â‚¬/g, '').trim();
    if (cleaned.includes(',') && !cleaned.includes('.')) cleaned = cleaned.replace(',', '.');
    else if (cleaned.includes(',') && cleaned.includes('.')) {
      const lastComma = cleaned.lastIndexOf(',');
      const lastDot = cleaned.lastIndexOf('.');
      if (lastComma > lastDot) cleaned = cleaned.replace(/\./g, '').replace(',', '.');
      else cleaned = cleaned.replace(/,/g, '');
    }
    const num = parseFloat(cleaned);
    return isNaN(num) ? null : num;
  }
  
  console.log('ğŸ”„ Chargement de Firebase...');
  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
  const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
  
  if (!window.firebaseConfig2) {
    console.error('âŒ Configuration Firebase secondaire (firebaseConfig2) non trouvÃ©e');
    return;
  }
  
  let app2;
  try {
    app2 = initializeApp(window.firebaseConfig2, 'secondary');
  } catch (error) {
    if (error.code === 'app/duplicate-app') {
      const { getApps } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
      app2 = getApps().find(app => app.name === 'secondary');
    } else {
      throw error;
    }
  }
  
  const db2 = getFirestore(app2);
  console.log('âœ… DeuxiÃ¨me base Firebase initialisÃ©e:', window.firebaseConfig2.projectId);
  
  const authState = JSON.parse(localStorage.getItem('ms_auth_state') || 'null');
  if (!authState || !authState.uid) {
    console.error('âŒ Vous devez Ãªtre connectÃ© pour importer des vÃ©hicules');
    return;
  }
  console.log('âœ… Utilisateur connectÃ©:', authState.email);
  
  const data = `Bentley	Bentayga	186 995 â‚¬	306	456	4	60	5 610 â‚¬	16 830 â‚¬	39 269 â‚¬	56 099 â‚¬
Bentley	Flying Spur 2020	197 200 â‚¬	333	635	3	60	5 916 â‚¬	17 748 â‚¬	41 412 â‚¬	59 160 â‚¬
Bentley	Muslanne Limousine 2017	296 250 â‚¬	255	300	5	25	8 888 â‚¬	26 663 â‚¬	62 213 â‚¬	88 875 â‚¬
BMW	I8 2015	93 750 â‚¬	280	750	3	15	2 813 â‚¬	8 438 â‚¬	19 688 â‚¬	28 125 â‚¬
BMW	330D E91 211	27 750 â‚¬	230	305	4	15	833 â‚¬	2 498 â‚¬	5 828 â‚¬	8 325 â‚¬
BMW	E38	17 250 â‚¬	250	450	3	15	518 â‚¬	1 553 â‚¬	3 623 â‚¬	5 175 â‚¬
BMW	M135i 2013	21 975 â‚¬	250	450	4	30	659 â‚¬	1 978 â‚¬	4 615 â‚¬	6 593 â‚¬
BMW	M140i 2019	32 000 â‚¬	253	335	4	30	960 â‚¬	2 880 â‚¬	6 720 â‚¬	9 600 â‚¬
BMW	M2 Competition 2018	67 500 â‚¬	290	410	3	15	2 025 â‚¬	6 075 â‚¬	14 175 â‚¬	20 250 â‚¬
BMW	M2	72 000 â‚¬	315	560	3	15	2 160 â‚¬	6 480 â‚¬	15 120 â‚¬	21 600 â‚¬
BMW	M3 e36 1997	23 437 â‚¬	257	450	3	15	703 â‚¬	2 109 â‚¬	4 922 â‚¬	7 031 â‚¬
BMW	M3 e36 BMW Power 1997	23 437 â‚¬	305	450	1	15	703 â‚¬	2 109 â‚¬	4 922 â‚¬	7 031 â‚¬
BMW	M3 GTR 2001	58 500 â‚¬	295	380	4	15	1 755 â‚¬	5 265 â‚¬	12 285 â‚¬	17 550 â‚¬
BMW	M3 2010	62 000 â‚¬	305	450	4	15	1 860 â‚¬	5 580 â‚¬	13 020 â‚¬	18 600 â‚¬
BMW	M3 Touring G81	111 125 â‚¬	300	510	4	25	3 334 â‚¬	10 001 â‚¬	23 336 â‚¬	33 338 â‚¬
BMW	M3 G80	108 000 â‚¬	290	510	4	25	3 240 â‚¬	9 720 â‚¬	22 680 â‚¬	32 400 â‚¬
BMW	M4 GTS F82 2016	187 500 â‚¬	305	500	4	30	5 625 â‚¬	16 875 â‚¬	39 375 â‚¬	56 250 â‚¬
BMW	M4 GTS F82 2016 T1	187 500 â‚¬	305	500	4	30	5 625 â‚¬	16 875 â‚¬	39 375 â‚¬	56 250 â‚¬
BMW	M4 Competition 2021	100 180 â‚¬	298	510	4	25	3 005 â‚¬	9 016 â‚¬	21 038 â‚¬	30 054 â‚¬
BMW	M5 F90 2018	118 593 â‚¬	312	625	4	25	3 558 â‚¬	10 673 â‚¬	24 905 â‚¬	35 578 â‚¬
BMW	M5 2022	168 750 â‚¬	325	955	4	25	5 063 â‚¬	15 188 â‚¬	35 438 â‚¬	50 625 â‚¬
BMW	M5 2024	184 798 â‚¬	305	727	4	25	5 544 â‚¬	16 632 â‚¬	38 808 â‚¬	55 439 â‚¬
BMW	M5 Touring G90 2024	203 277 â‚¬	305	717	4	25	6 098 â‚¬	18 295 â‚¬	42 688 â‚¬	60 983 â‚¬
BMW	M6 F13 2013	46 875 â‚¬	250	410	1	25	1 406 â‚¬	4 219 â‚¬	9 844 â‚¬	14 063 â‚¬
BMW	M8	164 013 â‚¬	305	650	3	30	4 920 â‚¬	14 761 â‚¬	34 443 â‚¬	49 204 â‚¬
BMW	X3 2016	26 250 â‚¬	250	555	4	15	788 â‚¬	2 363 â‚¬	5 513 â‚¬	7 875 â‚¬
BMW	X5M F85	69 939 â‚¬	250	400	4	60	2 098 â‚¬	6 295 â‚¬	14 687 â‚¬	20 982 â‚¬
BMW	X6M Competition 2021	75 000 â‚¬	270	225	4	60	2 250 â‚¬	6 750 â‚¬	15 750 â‚¬	22 500 â‚¬
BMW	Z4 GT3	238 400 â‚¬	404	600	0	25	7 152 â‚¬	21 456 â‚¬	50 064 â‚¬	71 520 â‚¬
Bugatti	Centodieci 2020	8 281 250 â‚¬	390	1600	1	10	248 438 â‚¬	745 313 â‚¬	1 739 063 â‚¬	2 484 375 â‚¬
Bugatti	Chiron Profiler	4 450 000 â‚¬	400	1500	1	10	133 500 â‚¬	400 500 â‚¬	934 500 â‚¬	1 335 000 â‚¬
Bugatti	Chiron Sport 2018	3 450 000 â‚¬	412	1800	1	10	103 500 â‚¬	310 500 â‚¬	724 500 â‚¬	1 035 000 â‚¬
Bugatti	Chiron Super Sport 300+	4 387 500 â‚¬	490	1600	1	10	131 625 â‚¬	394 875 â‚¬	921 375 â‚¬	1 316 250 â‚¬
Bugatti	Divo 2019	4 687 500 â‚¬	382	1500	1	10	140 625 â‚¬	421 875 â‚¬	984 375 â‚¬	1 406 250 â‚¬
Bugatti	Bolide	5 587 500 â‚¬	501	1800	1	10	167 625 â‚¬	502 875 â‚¬	1 173 375 â‚¬	1 676 250 â‚¬
Bugatti	La Voiture Noire 2019 Carbone	12 187 500 â‚¬	412	1500	4	10	365 625 â‚¬	1 096 875 â‚¬	2 559 375 â‚¬	3 656 250 â‚¬
Bugatti	La Voiture Noire 2019	10 312 500 â‚¬	412	1500	4	10	309 375 â‚¬	928 125 â‚¬	2 165 625 â‚¬	3 093 750 â‚¬
Bugatti	Mistral	4 959 000 â‚¬	453	1600	1	10	148 770 â‚¬	446 310 â‚¬	1 041 390 â‚¬	1 487 700 â‚¬
Bugatti	Tourbillon	3 869 000 â‚¬	410	1500	1	10	116 070 â‚¬	348 210 â‚¬	812 490 â‚¬	1 160 700 â‚¬
Bugatti	Veyron 16.4 Roadster 2012	1 233 375 â‚¬	394	1001	1	10	37 001 â‚¬	111 004 â‚¬	259 009 â‚¬	370 013 â‚¬`;
  
  const linesArray = data.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('//'));
  let imported = 0, errors = 0, skipped = 0;
  
  console.log(`ğŸš€ DÃ©but de l'importation de ${linesArray.length} vÃ©hicules dans la deuxiÃ¨me base...\n`);
  
  for (let i = 0; i < linesArray.length; i++) {
    const line = linesArray[i];
    const parts = line.split('\t');
    
    if (parts.length < 11) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (colonnes insuffisantes: ${parts.length})`);
      skipped++;
      continue;
    }
    
    const vehicle = {
      type: parts[0]?.trim() || 'Autre',
      modele: parts[1]?.trim() || '',
      prixAchat: parseFrenchNumber(parts[2]) || 0,
      vitesseMax: parseFrenchNumber(parts[3]),
      puissance: parseFrenchNumber(parts[4]),
      nombrePlaces: parseFrenchNumber(parts[5]),
      coffre: parseFrenchNumber(parts[6]),
      assuranceTier1: parseFrenchNumber(parts[7]),
      assuranceTier2: parseFrenchNumber(parts[8]),
      assuranceTier3: parseFrenchNumber(parts[9]),
      assuranceTier4: parseFrenchNumber(parts[10]),
      achete: false,
      createdAt: serverTimestamp()
    };
    
    if (!vehicle.modele || !vehicle.prixAchat) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (donnÃ©es incomplÃ¨tes)`);
      skipped++;
      continue;
    }
    
    try {
      await addDoc(collection(db2, 'flotte'), vehicle);
      imported++;
      if (imported % 10 === 0 || imported === 1) {
        console.log(`âœ… [${imported}] ${vehicle.modele}`);
      }
      if (imported % 50 === 0) {
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    } catch (error) {
      console.error(`âŒ Erreur ligne ${i + 1}: ${vehicle.modele}`, error.message || error);
      errors++;
    }
  }
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ“Š RÃ‰SUMÃ‰ DE L\'IMPORT');
  console.log('='.repeat(50));
  console.log(`âœ… ImportÃ©s: ${imported}`);
  console.log(`âŒ Erreurs: ${errors}`);
  console.log(`âš ï¸  IgnorÃ©s: ${skipped}`);
  console.log(`ğŸ“¦ Total traitÃ©: ${linesArray.length}`);
  console.log(`ğŸ—„ï¸  Base: ${window.firebaseConfig2.projectId}`);
  console.log('='.repeat(50));
})();
