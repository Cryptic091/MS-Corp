(async function() {
  function parseFrenchNumber(value) {
    if (!value || value === 'â€”' || value === '-' || value === '') return null;
    let cleaned = String(value).replace(/\s/g, '').replace(/â‚¬/g, '').trim();
    if (cleaned.includes(',') && !cleaned.includes('.')) cleaned = cleaned.replace(',', '.');
    else if (cleaned.includes(',') && cleaned.includes('.')) {
      const lastComma = cleaned.lastIndexOf(',');
      const lastDot = cleaned.lastIndexOf('.');
      if (lastComma > lastDot) cleaned = cleaned.replace(/\./g, '').replace(',', '.');
      else cleaned = cleaned.replace(/,/g, '');
    }
    const num = parseFloat(cleaned);
    return isNaN(num) ? null : num;
  }
  
  console.log('ğŸ”„ Chargement de Firebase...');
  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
  const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
  
  if (!window.firebaseConfig2) {
    console.error('âŒ Configuration Firebase secondaire (firebaseConfig2) non trouvÃ©e');
    return;
  }
  
  let app2;
  try {
    app2 = initializeApp(window.firebaseConfig2, 'secondary');
  } catch (error) {
    if (error.code === 'app/duplicate-app') {
      const { getApps } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
      app2 = getApps().find(app => app.name === 'secondary');
    } else {
      throw error;
    }
  }
  
  const db2 = getFirestore(app2);
  console.log('âœ… DeuxiÃ¨me base Firebase initialisÃ©e:', window.firebaseConfig2.projectId);
  
  const authState = JSON.parse(localStorage.getItem('ms_auth_state') || 'null');
  if (!authState || !authState.uid) {
    console.error('âŒ Vous devez Ãªtre connectÃ© pour importer des vÃ©hicules');
    return;
  }
  console.log('âœ… Utilisateur connectÃ©:', authState.email);
  
  const data = `Alfa Romeo	Gulia Quadrifloglio 2017	41 830 â‚¬	305	510	4	25	1 255 â‚¬	3 765 â‚¬	8 784 â‚¬	12 549 â‚¬
Alfa Romeo	Gulia Quadrifoglio 2017 Black Pack	46 850 â‚¬	305	510	4	25	1 406 â‚¬	4 217 â‚¬	9 839 â‚¬	14 055 â‚¬
Alfa Romeo	GTAM	80 000 â‚¬	300	540	1	25	2 400 â‚¬	7 200 â‚¬	16 800 â‚¬	24 000 â‚¬
Alfa Romeo	Mito	28 000 â‚¬	230	225	4	25	840 â‚¬	2 520 â‚¬	5 880 â‚¬	8 400 â‚¬
Apollo	Apollo Intensa Emozione 2018	2 165 250 â‚¬	335	780	1	10	64 958 â‚¬	194 873 â‚¬	454 703 â‚¬	649 575 â‚¬
Aston Martin	DBX 2020	188 250 â‚¬	291	650	4	15	5 648 â‚¬	16 943 â‚¬	39 533 â‚¬	56 475 â‚¬
Aston Martin	DBX 2020 MAT	282 645 â‚¬	291	650	4	15	8 479 â‚¬	25 438 â‚¬	59 355 â‚¬	84 794 â‚¬
Aston Martin	DBS Superleggera	374 995 â‚¬	338	725	1	15	11 250 â‚¬	33 750 â‚¬	78 749 â‚¬	112 499 â‚¬
Aston Martin	Vantage 2019	143 250 â‚¬	320	530	1	15	4 298 â‚¬	12 893 â‚¬	30 083 â‚¬	42 975 â‚¬
Aston Martin	Vantage 2019 Camo	214 856 â‚¬	320	530	1	15	6 446 â‚¬	19 337 â‚¬	45 120 â‚¬	64 457 â‚¬
Aston Martin	Vanquish 2013	120 000 â‚¬	300	552	3	20	3 600 â‚¬	10 800 â‚¬	25 200 â‚¬	36 000 â‚¬
Aston Martin	Valhalla	1 755 000 â‚¬	350	1079	1	15	52 650 â‚¬	157 950 â‚¬	368 550 â‚¬	526 500 â‚¬
Aston Martin	Victor	1 575 000 â‚¬	360	900	1	15	47 250 â‚¬	141 750 â‚¬	330 750 â‚¬	472 500 â‚¬
Aston Martin	Vulcan 2016	2 625 000 â‚¬	360	825	1	15	78 750 â‚¬	236 250 â‚¬	551 250 â‚¬	787 500 â‚¬
Audi	R8 2020	206 225 â‚¬	321	620	1	10	6 187 â‚¬	18 560 â‚¬	43 307 â‚¬	61 868 â‚¬
Audi	RS2 1995	16 875 â‚¬	253	475	4	40	506 â‚¬	1 519 â‚¬	3 544 â‚¬	5 063 â‚¬
Audi	RS3 2022	72 750 â‚¬	290	740	4	40	2 183 â‚¬	6 548 â‚¬	15 278 â‚¬	21 825 â‚¬
Audi	RS4 Avant	92 259 â‚¬	289	600	4	40	2 768 â‚¬	8 303 â‚¬	19 374 â‚¬	27 678 â‚¬
Audi	RS4 Avant 2018	76 500 â‚¬	255	600	4	40	2 295 â‚¬	6 885 â‚¬	16 065 â‚¬	22 950 â‚¬
Audi	RS4 Avant 2024	85 000 â‚¬	255	600	4	40	2 550 â‚¬	7 650 â‚¬	17 850 â‚¬	25 500 â‚¬
Audi	RS5 2020	82 500 â‚¬	263	450	4	40	2 475 â‚¬	7 425 â‚¬	17 325 â‚¬	24 750 â‚¬
Audi	RS6 C7	90 731 â‚¬	280	750	4	55	2 722 â‚¬	8 166 â‚¬	19 054 â‚¬	27 219 â‚¬
Audi	RS6 Avant 2020	121 875 â‚¬	305	600	4	55	3 656 â‚¬	10 969 â‚¬	25 594 â‚¬	36 563 â‚¬
Audi	RS6 Avant 2020 Black Pack	145 852 â‚¬	305	600	4	55	4 376 â‚¬	13 127 â‚¬	30 629 â‚¬	43 756 â‚¬
Audi	RS7 2013	67 500 â‚¬	330	800	3	35	2 025 â‚¬	6 075 â‚¬	14 175 â‚¬	20 250 â‚¬
Audi	RS7 Sportback 2020	134 825 â‚¬	327	610	4	35	4 045 â‚¬	12 134 â‚¬	28 313 â‚¬	40 448 â‚¬
Audi	RSQ8 2020	145 218 â‚¬	305	600	4	35	4 357 â‚¬	13 070 â‚¬	30 496 â‚¬	43 565 â‚¬
Audi	S1	34 787 â‚¬	250	400	3	20	1 044 â‚¬	3 131 â‚¬	7 305 â‚¬	10 436 â‚¬
Audi	S3	55 082 â‚¬	255	780	4	30	1 652 â‚¬	4 957 â‚¬	11 567 â‚¬	16 525 â‚¬
Audi	S3 2002	32 582 â‚¬	241	136	4	30	977 â‚¬	2 932 â‚¬	6 842 â‚¬	9 775 â‚¬
Audi	S3 2022	58 660 â‚¬	250	725	4	30	1 760 â‚¬	5 279 â‚¬	12 319 â‚¬	17 598 â‚¬`;
  
  const linesArray = data.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('//'));
  let imported = 0, errors = 0, skipped = 0;
  
  console.log(`ğŸš€ DÃ©but de l'importation de ${linesArray.length} vÃ©hicules dans la deuxiÃ¨me base...\n`);
  
  for (let i = 0; i < linesArray.length; i++) {
    const line = linesArray[i];
    const parts = line.split('\t');
    
    if (parts.length < 11) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (colonnes insuffisantes: ${parts.length})`);
      skipped++;
      continue;
    }
    
    const vehicle = {
      type: parts[0]?.trim() || 'Autre',
      modele: parts[1]?.trim() || '',
      prixAchat: parseFrenchNumber(parts[2]) || 0,
      vitesseMax: parseFrenchNumber(parts[3]),
      puissance: parseFrenchNumber(parts[4]),
      nombrePlaces: parseFrenchNumber(parts[5]),
      coffre: parseFrenchNumber(parts[6]),
      assuranceTier1: parseFrenchNumber(parts[7]),
      assuranceTier2: parseFrenchNumber(parts[8]),
      assuranceTier3: parseFrenchNumber(parts[9]),
      assuranceTier4: parseFrenchNumber(parts[10]),
      achete: false,
      createdAt: serverTimestamp()
    };
    
    if (!vehicle.modele || !vehicle.prixAchat) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (donnÃ©es incomplÃ¨tes)`);
      skipped++;
      continue;
    }
    
    try {
      await addDoc(collection(db2, 'flotte'), vehicle);
      imported++;
      if (imported % 10 === 0 || imported === 1) {
        console.log(`âœ… [${imported}] ${vehicle.type} ${vehicle.modele}`);
      }
      if (imported % 50 === 0) {
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    } catch (error) {
      console.error(`âŒ Erreur ligne ${i + 1}: ${vehicle.modele}`, error.message || error);
      errors++;
    }
  }
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ“Š RÃ‰SUMÃ‰ DE L\'IMPORT');
  console.log('='.repeat(50));
  console.log(`âœ… ImportÃ©s: ${imported}`);
  console.log(`âŒ Erreurs: ${errors}`);
  console.log(`âš ï¸  IgnorÃ©s: ${skipped}`);
  console.log(`ğŸ“¦ Total traitÃ©: ${linesArray.length}`);
  console.log(`ğŸ—„ï¸  Base: ${window.firebaseConfig2.projectId}`);
  console.log('='.repeat(50));
})();
