(async function() {
  function parseFrenchNumber(value) {
    if (!value || value === 'â€”' || value === '-' || value === '') return null;
    let cleaned = String(value).replace(/\s/g, '').replace(/â‚¬/g, '').trim();
    if (cleaned.includes(',') && !cleaned.includes('.')) cleaned = cleaned.replace(',', '.');
    else if (cleaned.includes(',') && cleaned.includes('.')) {
      const lastComma = cleaned.lastIndexOf(',');
      const lastDot = cleaned.lastIndexOf('.');
      if (lastComma > lastDot) cleaned = cleaned.replace(/\./g, '').replace(',', '.');
      else cleaned = cleaned.replace(/,/g, '');
    }
    const num = parseFloat(cleaned);
    return isNaN(num) ? null : num;
  }
  
  console.log('ğŸ”„ Chargement de Firebase...');
  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
  const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
  
  if (!window.firebaseConfig2) {
    console.error('âŒ Configuration Firebase secondaire (firebaseConfig2) non trouvÃ©e');
    return;
  }
  
  let app2;
  try {
    app2 = initializeApp(window.firebaseConfig2, 'secondary');
  } catch (error) {
    if (error.code === 'app/duplicate-app') {
      const { getApps } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
      app2 = getApps().find(app => app.name === 'secondary');
    } else {
      throw error;
    }
  }
  
  const db2 = getFirestore(app2);
  console.log('âœ… DeuxiÃ¨me base Firebase initialisÃ©e:', window.firebaseConfig2.projectId);
  
  const authState = JSON.parse(localStorage.getItem('ms_auth_state') || 'null');
  if (!authState || !authState.uid) {
    console.error('âŒ Vous devez Ãªtre connectÃ© pour importer des vÃ©hicules');
    return;
  }
  console.log('âœ… Utilisateur connectÃ©:', authState.email);
  
  const data = `Cadillac	CTS-V	105 787 â‚¬	249	550	4	32	3 174 â‚¬	9 521 â‚¬	22 215 â‚¬	31 736 â‚¬
Cadillac	Escalade	149 906 â‚¬	198	325	5	32	4 497 â‚¬	13 492 â‚¬	31 480 â‚¬	44 972 â‚¬
Cadillac	XTS	136 687 â‚¬	209	325	5	40	4 101 â‚¬	12 302 â‚¬	28 704 â‚¬	41 006 â‚¬
Chevrolet	Camaro 1969	58 515 â‚¬	271	400	1	20	1 755 â‚¬	5 266 â‚¬	12 288 â‚¬	17 555 â‚¬
Chevrolet	Camaro 2017	71 207 â‚¬	294	600	1	20	2 136 â‚¬	6 409 â‚¬	14 953 â‚¬	21 362 â‚¬
Chevrolet	Corvette C7 Stingray 2014	65 615 â‚¬	290	466	1	20	1 968 â‚¬	5 905 â‚¬	13 779 â‚¬	19 685 â‚¬
Chevrolet	Corvette C8 2020	111 217 â‚¬	371	550	1	20	3 337 â‚¬	10 010 â‚¬	23 356 â‚¬	33 365 â‚¬
Chevrolet	Corvette ZR1 2016	182 217 â‚¬	371	550	1	20	5 467 â‚¬	16 400 â‚¬	38 266 â‚¬	54 665 â‚¬
Chevrolet	Corvette Z06 2023	162 217 â‚¬	399	550	1	20	4 867 â‚¬	14 600 â‚¬	34 066 â‚¬	48 665 â‚¬
Chevrolet	Colorado	42 975 â‚¬	168	400	4	20	1 289 â‚¬	3 868 â‚¬	9 025 â‚¬	12 893 â‚¬
Chevrolet	Colorado Phase ll	45 123 â‚¬	168	400	4	20	1 354 â‚¬	4 061 â‚¬	9 476 â‚¬	13 537 â‚¬
Chevrolet	Impala 1959	32 301 â‚¬	177	250	3	32	969 â‚¬	2 907 â‚¬	6 783 â‚¬	9 690 â‚¬
Chevrolet	Impala 1967	32 301 â‚¬	191	275	3	32	969 â‚¬	2 907 â‚¬	6 783 â‚¬	9 690 â‚¬
Chevrolet	K5 Blazer 1980	21 988 â‚¬	177	275	3	32	660 â‚¬	1 979 â‚¬	4 617 â‚¬	6 596 â‚¬
Chevrolet	Suburban	113 343 â‚¬	231	300	6	80	3 400 â‚¬	10 201 â‚¬	23 802 â‚¬	34 003 â‚¬
Chevrolet	Suburban Chevy 2021	82 000 â‚¬	250	600	6	20	2 460 â‚¬	7 380 â‚¬	17 220 â‚¬	24 600 â‚¬
Chevrolet	Tahoe	98 727 â‚¬	256	325	5	80	2 962 â‚¬	8 885 â‚¬	20 733 â‚¬	29 618 â‚¬
Chrysler	Pacifica	80 436 â‚¬	256	325	6	55	2 413 â‚¬	7 239 â‚¬	16 892 â‚¬	24 131 â‚¬
CitroÃ«n	Ami	7 069 â‚¬	80	510	1	25	212 â‚¬	636 â‚¬	1 484 â‚¬	2 121 â‚¬
CitroÃ«n	Berlingo	22 500 â‚¬	212	130	4	40	675 â‚¬	2 025 â‚¬	4 725 â‚¬	6 750 â‚¬
CitroÃ«n	2CV	3 000 â‚¬	135	30	3	25	90 â‚¬	270 â‚¬	630 â‚¬	900 â‚¬
CitroÃ«n	DS7 Performance Line 2022	72 000 â‚¬	260	360	4	60	2 160 â‚¬	6 480 â‚¬	15 120 â‚¬	21 600 â‚¬
CitroÃ«n	C4 2012	12 654 â‚¬	220	198	4	55	380 â‚¬	1 139 â‚¬	2 657 â‚¬	3 796 â‚¬`;
  
  const linesArray = data.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('//'));
  let imported = 0, errors = 0, skipped = 0;
  
  console.log(`ğŸš€ DÃ©but de l'importation de ${linesArray.length} vÃ©hicules dans la deuxiÃ¨me base...\n`);
  
  for (let i = 0; i < linesArray.length; i++) {
    const line = linesArray[i];
    const parts = line.split('\t');
    
    if (parts.length < 11) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (colonnes insuffisantes: ${parts.length})`);
      skipped++;
      continue;
    }
    
    const vehicle = {
      type: parts[0]?.trim() || 'Autre',
      modele: parts[1]?.trim() || '',
      prixAchat: parseFrenchNumber(parts[2]) || 0,
      vitesseMax: parseFrenchNumber(parts[3]),
      puissance: parseFrenchNumber(parts[4]),
      nombrePlaces: parseFrenchNumber(parts[5]),
      coffre: parseFrenchNumber(parts[6]),
      assuranceTier1: parseFrenchNumber(parts[7]),
      assuranceTier2: parseFrenchNumber(parts[8]),
      assuranceTier3: parseFrenchNumber(parts[9]),
      assuranceTier4: parseFrenchNumber(parts[10]),
      achete: false,
      createdAt: serverTimestamp()
    };
    
    if (!vehicle.modele || !vehicle.prixAchat) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (donnÃ©es incomplÃ¨tes)`);
      skipped++;
      continue;
    }
    
    try {
      await addDoc(collection(db2, 'flotte'), vehicle);
      imported++;
      if (imported % 10 === 0 || imported === 1) {
        console.log(`âœ… [${imported}] ${vehicle.type} ${vehicle.modele}`);
      }
      if (imported % 50 === 0) {
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    } catch (error) {
      console.error(`âŒ Erreur ligne ${i + 1}: ${vehicle.modele}`, error.message || error);
      errors++;
    }
  }
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ“Š RÃ‰SUMÃ‰ DE L\'IMPORT');
  console.log('='.repeat(50));
  console.log(`âœ… ImportÃ©s: ${imported}`);
  console.log(`âŒ Erreurs: ${errors}`);
  console.log(`âš ï¸  IgnorÃ©s: ${skipped}`);
  console.log(`ğŸ“¦ Total traitÃ©: ${linesArray.length}`);
  console.log(`ğŸ—„ï¸  Base: ${window.firebaseConfig2.projectId}`);
  console.log('='.repeat(50));
})();