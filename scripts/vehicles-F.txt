(async function() {
  function parseFrenchNumber(value) {
    if (!value || value === 'â€”' || value === '-' || value === '') return null;
    let cleaned = String(value).replace(/\s/g, '').replace(/â‚¬/g, '').trim();
    if (cleaned.includes(',') && !cleaned.includes('.')) cleaned = cleaned.replace(',', '.');
    else if (cleaned.includes(',') && cleaned.includes('.')) {
      const lastComma = cleaned.lastIndexOf(',');
      const lastDot = cleaned.lastIndexOf('.');
      if (lastComma > lastDot) cleaned = cleaned.replace(/\./g, '').replace(',', '.');
      else cleaned = cleaned.replace(/,/g, '');
    }
    const num = parseFloat(cleaned);
    return isNaN(num) ? null : num;
  }
  
  console.log('ğŸ”„ Chargement de Firebase...');
  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
  const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
  
  if (!window.firebaseConfig2) {
    console.error('âŒ Configuration Firebase secondaire (firebaseConfig2) non trouvÃ©e');
    return;
  }
  
  let app2;
  try {
    app2 = initializeApp(window.firebaseConfig2, 'secondary');
  } catch (error) {
    if (error.code === 'app/duplicate-app') {
      const { getApps } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
      app2 = getApps().find(app => app.name === 'secondary');
    } else {
      throw error;
    }
  }
  
  const db2 = getFirestore(app2);
  console.log('âœ… DeuxiÃ¨me base Firebase initialisÃ©e:', window.firebaseConfig2.projectId);
  
  const authState = JSON.parse(localStorage.getItem('ms_auth_state') || 'null');
  if (!authState || !authState.uid) {
    console.error('âŒ Vous devez Ãªtre connectÃ© pour importer des vÃ©hicules');
    return;
  }
  console.log('âœ… Utilisateur connectÃ©:', authState.email);
  
  const data = `Ferrari	458 Italia 2010	184â€¯624 â‚¬	358	570	1	10	5â€¯539 â‚¬	16â€¯616 â‚¬	38â€¯771 â‚¬	55â€¯387 â‚¬
Ferrari	250 GTO	750â€¯000 â‚¬	280	412	1	10	22â€¯500 â‚¬	67â€¯500 â‚¬	157â€¯500 â‚¬	225â€¯000 â‚¬
Ferrari	458 Italia 2010 Tuning	277â€¯000 â‚¬	325	570	1	10	8â€¯310 â‚¬	24â€¯930 â‚¬	58â€¯170 â‚¬	83â€¯100 â‚¬
Ferrari	488 Pista 2019	400â€¯000 â‚¬	340	720	1	10	12â€¯000 â‚¬	36â€¯000 â‚¬	84â€¯000 â‚¬	120â€¯000 â‚¬
Ferrari	12 Cilindri 2024	387â€¯751 â‚¬	340	830	1	10	11â€¯633 â‚¬	34â€¯898 â‚¬	81â€¯428 â‚¬	116â€¯325 â‚¬
Ferrari	Purosangue	384â€¯229 â‚¬	310	725	3	10	11â€¯527 â‚¬	34â€¯581 â‚¬	80â€¯688 â‚¬	115â€¯269 â‚¬
Ferrari	812 Superfast 2017	280â€¯000 â‚¬	341	800	1	22	8â€¯400 â‚¬	25â€¯200 â‚¬	58â€¯800 â‚¬	84â€¯000 â‚¬
Ferrari	F8 Tributo 2019	218â€¯000 â‚¬	346	720	1	10	6â€¯540 â‚¬	19â€¯620 â‚¬	45â€¯780 â‚¬	65â€¯400 â‚¬
Ferrari	F12 Berlinetta 2014	195â€¯000 â‚¬	344	740	1	15	5â€¯850 â‚¬	17â€¯550 â‚¬	40â€¯950 â‚¬	58â€¯500 â‚¬
Ferrari	LaFerrari 2015	1â€¯725â€¯000 â‚¬	370	963	1	10	51â€¯750 â‚¬	155â€¯250 â‚¬	362â€¯250 â‚¬	517â€¯500 â‚¬
Ferrari	Monza SP2 2019	1â€¯500â€¯000 â‚¬	300	810	1	10	45â€¯000 â‚¬	135â€¯000 â‚¬	315â€¯000 â‚¬	450â€¯000 â‚¬
Ferrari	Daytona SP3	1â€¯723â€¯619 â‚¬	346	970	1	10	51â€¯709 â‚¬	155â€¯126 â‚¬	361â€¯960 â‚¬	517â€¯086 â‚¬
Ferrari	SP48 Unica	380â€¯000 â‚¬	340	720	1	10	11â€¯400 â‚¬	34â€¯200 â‚¬	79â€¯800 â‚¬	114â€¯000 â‚¬
Ferrari	SF90 Stradal	529â€¯467 â‚¬	346	970	1	10	15â€¯884 â‚¬	47â€¯652 â‚¬	111â€¯188 â‚¬	158â€¯840 â‚¬
Ferrari	SF90 XX Stradale 2024	829â€¯467 â‚¬	340	1030	1	10	24â€¯884 â‚¬	74â€¯652 â‚¬	174â€¯188 â‚¬	248â€¯840 â‚¬
Ferrari	Roma 2020	194â€¯000 â‚¬	320	740	3	10	5â€¯820 â‚¬	17â€¯460 â‚¬	40â€¯740 â‚¬	58â€¯200 â‚¬
Fiat	500 Abarth 595 Essence	30â€¯000 â‚¬	260	185	3	10	900 â‚¬	2â€¯700 â‚¬	6â€¯300 â‚¬	9â€¯000 â‚¬
Fiat	Multipla	21â€¯000 â‚¬	176	1105	5	45	630 â‚¬	1â€¯890 â‚¬	4â€¯410 â‚¬	6â€¯300 â‚¬
Ford	Branco 1989	19â€¯000 â‚¬	188	275	1	35	570 â‚¬	1â€¯710 â‚¬	3â€¯990 â‚¬	5â€¯700 â‚¬
Ford	Crown Victoria 2011	27â€¯500 â‚¬	205	193	4	35	825 â‚¬	2â€¯475 â‚¬	5â€¯775 â‚¬	8â€¯250 â‚¬
Ford	Explorer 2020	75â€¯000 â‚¬	230	450	4	100	2â€¯250 â‚¬	6â€¯750 â‚¬	15â€¯750 â‚¬	22â€¯500 â‚¬
Ford	Explorer ST 2020	78â€¯000 â‚¬	250	600	4	100	2â€¯340 â‚¬	7â€¯020 â‚¬	16â€¯380 â‚¬	23â€¯400 â‚¬
Ford	Everest	82â€¯700 â‚¬	241	350	4	50	2â€¯481 â‚¬	7â€¯443 â‚¬	17â€¯367 â‚¬	24â€¯810 â‚¬
Ford	F-150 1980	5â€¯420 â‚¬	169	275	1	40	163 â‚¬	488 â‚¬	1â€¯138 â‚¬	1â€¯626 â‚¬
Ford	Focus RS 2009	35â€¯250 â‚¬	254	400	1	35	1â€¯058 â‚¬	3â€¯173 â‚¬	7â€¯403 â‚¬	10â€¯575 â‚¬
Ford	Focus RS 2017	41â€¯250 â‚¬	265	400	4	35	1â€¯238 â‚¬	3â€¯713 â‚¬	8â€¯663 â‚¬	12â€¯375 â‚¬
Ford	GT 2017	330â€¯000 â‚¬	345	647	1	10	9â€¯900 â‚¬	29â€¯700 â‚¬	69â€¯300 â‚¬	99â€¯000 â‚¬
Ford	GT40 1964	105â€¯642 â‚¬	279	550	1	10	3â€¯169 â‚¬	9â€¯508 â‚¬	22â€¯185 â‚¬	31â€¯693 â‚¬
Ford	Galaxy 2009	9â€¯950 â‚¬	238	180	4	40	299 â‚¬	896 â‚¬	2â€¯090 â‚¬	2â€¯985 â‚¬
Ford	Galaxy 2016	25â€¯750 â‚¬	242	210	4	40	773 â‚¬	2â€¯318 â‚¬	5â€¯408 â‚¬	7â€¯725 â‚¬
Ford	Maverick 2022	101â€¯560 â‚¬	245	365	4	50	3â€¯047 â‚¬	9â€¯140 â‚¬	21â€¯328 â‚¬	30â€¯468 â‚¬
Ford	Mondeo 2013 Berline	28â€¯500 â‚¬	262	250	4	30	855 â‚¬	2â€¯565 â‚¬	5â€¯985 â‚¬	8â€¯550 â‚¬
Ford	Mondeo 2009 SW	25â€¯500 â‚¬	243	250	4	80	765 â‚¬	2â€¯295 â‚¬	5â€¯355 â‚¬	7â€¯650 â‚¬
Ford	Mondeo SW 2015	31â€¯500 â‚¬	250	650	4	35	945 â‚¬	2â€¯835 â‚¬	6â€¯615 â‚¬	9â€¯450 â‚¬
Ford	Mustang Fastback 1966	89â€¯990 â‚¬	200	270	3	35	2â€¯700 â‚¬	8â€¯099 â‚¬	18â€¯898 â‚¬	26â€¯997 â‚¬
Ford	Mustang GT 2008 Convertible	21â€¯250 â‚¬	240	210	3	35	638 â‚¬	1â€¯913 â‚¬	4â€¯463 â‚¬	6â€¯375 â‚¬
Ford	Mustang GT 2015	50â€¯000 â‚¬	280	500	3	30	1â€¯500 â‚¬	4â€¯500 â‚¬	10â€¯500 â‚¬	15â€¯000 â‚¬
Ford	Mustang Dark Horse 2024	67â€¯000 â‚¬	290	552	3	30	2â€¯010 â‚¬	6â€¯030 â‚¬	14â€¯070 â‚¬	20â€¯100 â‚¬
Ford	Mustang 1970	108â€¯750 â‚¬	240	320	3	35	3â€¯263 â‚¬	9â€¯788 â‚¬	22â€¯838 â‚¬	32â€¯625 â‚¬
Ford	Mach E 2021	62â€¯500 â‚¬	235	462	4	45	1â€¯875 â‚¬	5â€¯625 â‚¬	13â€¯125 â‚¬	18â€¯750 â‚¬
Ford	F-350 Super Duty	34â€¯000 â‚¬	210	177	4	130	1â€¯020 â‚¬	3â€¯060 â‚¬	7â€¯140 â‚¬	10â€¯200 â‚¬
Ford	Ranger 2017	33â€¯300 â‚¬	235	250	4	110	999 â‚¬	2â€¯997 â‚¬	6â€¯993 â‚¬	9â€¯990 â‚¬
Ford	Ranger 2017 2	34â€¯800 â‚¬	235	250	4	110	1â€¯044 â‚¬	3â€¯132 â‚¬	7â€¯308 â‚¬	10â€¯440 â‚¬
Ford	Raptor	103â€¯000 â‚¬	171	325	4	110	3â€¯090 â‚¬	9â€¯270 â‚¬	21â€¯630 â‚¬	30â€¯900 â‚¬
Ford	S-Max	45â€¯652 â‚¬	247	350	4	110	1â€¯370 â‚¬	4â€¯109 â‚¬	9â€¯587 â‚¬	13â€¯696 â‚¬
Ford	Taurus	25â€¯300 â‚¬	310	350	4	70	759 â‚¬	2â€¯277 â‚¬	5â€¯313 â‚¬	7â€¯590 â‚¬
Ford	Velociraptor	237â€¯300 â‚¬	183	325	4	110	7â€¯119 â‚¬	21â€¯357 â‚¬	49â€¯833 â‚¬	71â€¯190 â‚¬
Ford	F-550	109â€¯000 â‚¬	171	350	4	110	3â€¯270 â‚¬	9â€¯810 â‚¬	22â€¯890 â‚¬	32â€¯700 â‚¬
Ford	F-550 Camo Type 1	109â€¯000 â‚¬	171	350	4	110	3â€¯270 â‚¬	9â€¯810 â‚¬	22â€¯890 â‚¬	32â€¯700 â‚¬
Ford	F-550 Camo Type 2	109â€¯000 â‚¬	171	350	4	110	3â€¯270 â‚¬	9â€¯810 â‚¬	22â€¯890 â‚¬	32â€¯700 â‚¬
Ford	F-550 Camo Type 3	109â€¯000 â‚¬	171	350	4	110	3â€¯270 â‚¬	9â€¯810 â‚¬	22â€¯890 â‚¬	32â€¯700 â‚¬`;
  
  const linesArray = data.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('//'));
  let imported = 0, errors = 0, skipped = 0;
  
  console.log(`ğŸš€ DÃ©but de l'importation de ${linesArray.length} vÃ©hicules dans la deuxiÃ¨me base...\n`);
  
  for (let i = 0; i < linesArray.length; i++) {
    const line = linesArray[i];
    const parts = line.split('\t');
    
    if (parts.length < 11) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (colonnes insuffisantes: ${parts.length})`);
      skipped++;
      continue;
    }
    
    const vehicle = {
      type: parts[0]?.trim() || 'Autre',
      modele: parts[1]?.trim() || '',
      prixAchat: parseFrenchNumber(parts[2]) || 0,
      vitesseMax: parseFrenchNumber(parts[3]),
      puissance: parseFrenchNumber(parts[4]),
      nombrePlaces: parseFrenchNumber(parts[5]),
      coffre: parseFrenchNumber(parts[6]),
      assuranceTier1: parseFrenchNumber(parts[7]),
      assuranceTier2: parseFrenchNumber(parts[8]),
      assuranceTier3: parseFrenchNumber(parts[9]),
      assuranceTier4: parseFrenchNumber(parts[10]),
      achete: false,
      createdAt: serverTimestamp()
    };
    
    if (!vehicle.modele || !vehicle.prixAchat) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (donnÃ©es incomplÃ¨tes)`);
      skipped++;
      continue;
    }
    
    try {
      await addDoc(collection(db2, 'flotte'), vehicle);
      imported++;
      if (imported % 10 === 0 || imported === 1) {
        console.log(`âœ… [${imported}] ${vehicle.type} ${vehicle.modele}`);
      }
      if (imported % 50 === 0) {
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    } catch (error) {
      console.error(`âŒ Erreur ligne ${i + 1}: ${vehicle.modele}`, error.message || error);
      errors++;
    }
  }
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ“Š RÃ‰SUMÃ‰ DE L\'IMPORT');
  console.log('='.repeat(50));
  console.log(`âœ… ImportÃ©s: ${imported}`);
  console.log(`âŒ Erreurs: ${errors}`);
  console.log(`âš ï¸  IgnorÃ©s: ${skipped}`);
  console.log(`ğŸ“¦ Total traitÃ©: ${linesArray.length}`);
  console.log(`ğŸ—„ï¸  Base: ${window.firebaseConfig2.projectId}`);
  console.log('='.repeat(50));
})();