(async function() {
  function parseFrenchNumber(value) {
    if (!value || value === 'â€”' || value === '-' || value === '') return null;
    let cleaned = String(value).replace(/\s/g, '').replace(/â‚¬/g, '').trim();
    if (cleaned.includes(',') && !cleaned.includes('.')) cleaned = cleaned.replace(',', '.');
    else if (cleaned.includes(',') && cleaned.includes('.')) {
      const lastComma = cleaned.lastIndexOf(',');
      const lastDot = cleaned.lastIndexOf('.');
      if (lastComma > lastDot) cleaned = cleaned.replace(/\./g, '').replace(',', '.');
      else cleaned = cleaned.replace(/,/g, '');
    }
    const num = parseFloat(cleaned);
    return isNaN(num) ? null : num;
  }
  
  console.log('ğŸ”„ Chargement de Firebase...');
  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
  const { getFirestore, collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js');
  
  if (!window.firebaseConfig2) {
    console.error('âŒ Configuration Firebase secondaire (firebaseConfig2) non trouvÃ©e');
    return;
  }
  
  let app2;
  try {
    app2 = initializeApp(window.firebaseConfig2, 'secondary');
  } catch (error) {
    if (error.code === 'app/duplicate-app') {
      const { getApps } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js');
      app2 = getApps().find(app => app.name === 'secondary');
    } else {
      throw error;
    }
  }
  
  const db2 = getFirestore(app2);
  console.log('âœ… DeuxiÃ¨me base Firebase initialisÃ©e:', window.firebaseConfig2.projectId);
  
  const authState = JSON.parse(localStorage.getItem('ms_auth_state') || 'null');
  if (!authState || !authState.uid) {
    console.error('âŒ Vous devez Ãªtre connectÃ© pour importer des vÃ©hicules');
    return;
  }
  console.log('âœ… Utilisateur connectÃ©:', authState.email);
  
  const data = `Utilitaires	CitroÃ«n Berlingo VAN 2019	33â€¯750 â‚¬	192	140	1	305	1â€¯013 â‚¬	3â€¯038 â‚¬	7â€¯088 â‚¬	10â€¯125 â‚¬
Utilitaires	CitroÃ«n C15	11â€¯500 â‚¬	147	75	1	110	345 â‚¬	1â€¯035 â‚¬	2â€¯415 â‚¬	3â€¯450 â‚¬
Utilitaires	CitroÃ«n C15 2	14â€¯500 â‚¬	147	75	1	110	435 â‚¬	1â€¯305 â‚¬	3â€¯045 â‚¬	4â€¯350 â‚¬
Utilitaires	CitroÃ«n Jumper	45â€¯000 â‚¬	192	140	2	375	1â€¯350 â‚¬	4â€¯050 â‚¬	9â€¯450 â‚¬	13â€¯500 â‚¬
Utilitaires	CitroÃ«n Jumper Mini-Bus	38â€¯000 â‚¬	192	140	9	50	1â€¯140 â‚¬	3â€¯420 â‚¬	7â€¯980 â‚¬	11â€¯400 â‚¬
Utilitaires	CitroÃ«n Jumper XL	52â€¯500 â‚¬	192	140	2	400	1â€¯575 â‚¬	4â€¯725 â‚¬	11â€¯025 â‚¬	15â€¯750 â‚¬
Utilitaires	CitroÃ«n Jumper Bus XL	21â€¯000 â‚¬	192	140	12	150	630 â‚¬	1â€¯890 â‚¬	4â€¯410 â‚¬	6â€¯300 â‚¬
Utilitaires	Fiat Ducato FG	45â€¯000 â‚¬	197	140	2	375	1â€¯350 â‚¬	4â€¯050 â‚¬	9â€¯450 â‚¬	13â€¯500 â‚¬
Utilitaires	FIat Ducato 2020	37â€¯500 â‚¬	210	115	8	50	1â€¯125 â‚¬	3â€¯375 â‚¬	7â€¯875 â‚¬	11â€¯250 â‚¬
Utilitaires	FIat Ducato 2020 Cargo	45â€¯000 â‚¬	205	200	2	375	1â€¯350 â‚¬	4â€¯050 â‚¬	9â€¯450 â‚¬	13â€¯500 â‚¬
Utilitaires	FIat Ducato 2020 Long	21â€¯000 â‚¬	205	200	12	150	630 â‚¬	1â€¯890 â‚¬	4â€¯410 â‚¬	6â€¯300 â‚¬
Utilitaires	FIat Ducato 2020 Cargo Long	52â€¯500 â‚¬	205	200	2	400	1â€¯575 â‚¬	4â€¯725 â‚¬	11â€¯025 â‚¬	15â€¯750 â‚¬
Utilitaires	Ford Transit	41â€¯250 â‚¬	190	400	10	350	1â€¯238 â‚¬	3â€¯713 â‚¬	8â€¯663 â‚¬	12â€¯375 â‚¬
Utilitaires	GMC Vandura	22â€¯500 â‚¬	161	200	1	250	675 â‚¬	2â€¯025 â‚¬	4â€¯725 â‚¬	6â€¯750 â‚¬
Utilitaires	Iveco Daily Cargo	41â€¯250 â‚¬	181	175	2	350	1â€¯238 â‚¬	3â€¯713 â‚¬	8â€¯663 â‚¬	12â€¯375 â‚¬
Utilitaires	Iveco Daily Mixe	22â€¯500 â‚¬	181	175	5	175	675 â‚¬	2â€¯025 â‚¬	4â€¯725 â‚¬	6â€¯750 â‚¬
Utilitaires	Iveco Daily Slim Cargo	21â€¯000 â‚¬	181	175	2	150	630 â‚¬	1â€¯890 â‚¬	4â€¯410 â‚¬	6â€¯300 â‚¬
Utilitaires	Iveco Daily Mini-Bus	37â€¯500 â‚¬	181	175	9	50	1â€¯125 â‚¬	3â€¯375 â‚¬	7â€¯875 â‚¬	11â€¯250 â‚¬
Utilitaires	Mercedes Sprinter 2019 Cargo	52â€¯500 â‚¬	220	140	1	400	1â€¯575 â‚¬	4â€¯725 â‚¬	11â€¯025 â‚¬	15â€¯750 â‚¬
Utilitaires	Mercedes Sprinter 2019 Mini-Bus	40â€¯500 â‚¬	220	140	7	50	1â€¯215 â‚¬	3â€¯645 â‚¬	8â€¯505 â‚¬	12â€¯150 â‚¬
Utilitaires	Mercedes Benz Sprinter	52â€¯500 â‚¬	170	140	1	400	1â€¯575 â‚¬	4â€¯725 â‚¬	11â€¯025 â‚¬	15â€¯750 â‚¬
Utilitaires	Mercedes Vito	22â€¯500 â‚¬	186	200	6	250	675 â‚¬	2â€¯025 â‚¬	4â€¯725 â‚¬	6â€¯750 â‚¬
Utilitaires	Peugeot Expert 3	28â€¯750 â‚¬	210	130	4	300	863 â‚¬	2â€¯588 â‚¬	6â€¯038 â‚¬	8â€¯625 â‚¬
Utilitaires	Peugeot Expert 3 Cargo	33â€¯750 â‚¬	210	130	1	325	1â€¯013 â‚¬	3â€¯038 â‚¬	7â€¯088 â‚¬	10â€¯125 â‚¬
Utilitaires	Peugeot Boxer	52â€¯500 â‚¬	182	140	2	400	1â€¯575 â‚¬	4â€¯725 â‚¬	11â€¯025 â‚¬	15â€¯750 â‚¬
Utilitaires	Renault Express	11â€¯500 â‚¬	147	75	1	110	345 â‚¬	1â€¯035 â‚¬	2â€¯415 â‚¬	3â€¯450 â‚¬
Utilitaires	Renault Express 2	14â€¯500 â‚¬	147	75	1	110	435 â‚¬	1â€¯305 â‚¬	3â€¯045 â‚¬	4â€¯350 â‚¬
Utilitaires	Renault Master 2024	54â€¯500 â‚¬	190	170	2	400	1â€¯635 â‚¬	4â€¯905 â‚¬	11â€¯445 â‚¬	16â€¯350 â‚¬
Utilitaires	Renault Master 2024 Bus	54â€¯500 â‚¬	190	170	2	400	1â€¯635 â‚¬	4â€¯905 â‚¬	11â€¯445 â‚¬	16â€¯350 â‚¬
Utilitaires	Renault Master 4 Cargo	52â€¯500 â‚¬	197	140	2	400	1â€¯575 â‚¬	4â€¯725 â‚¬	11â€¯025 â‚¬	15â€¯750 â‚¬
Utilitaires	Renault Master 4 Mini-Bus	40â€¯500 â‚¬	197	140	8	50	1â€¯215 â‚¬	3â€¯645 â‚¬	8â€¯505 â‚¬	12â€¯150 â‚¬
Utilitaires	Renaul Trafic 2 Cargo L1P1	33â€¯750 â‚¬	197	140	1	300	1â€¯013 â‚¬	3â€¯038 â‚¬	7â€¯088 â‚¬	10â€¯125 â‚¬
Utilitaires	Renault Trafic 2 L1P1	9â€¯000 â‚¬	197	140	6	50	270 â‚¬	810 â‚¬	1â€¯890 â‚¬	2â€¯700 â‚¬
Utilitaires	Renault Trafic 3 Cargo L1P1	37â€¯500 â‚¬	197	140	1	325	1â€¯125 â‚¬	3â€¯375 â‚¬	7â€¯875 â‚¬	11â€¯250 â‚¬
Utilitaires	Renault Trafic 3 Mini-Bus L1P1	9â€¯500 â‚¬	197	140	6	50	285 â‚¬	855 â‚¬	1â€¯995 â‚¬	2â€¯850 â‚¬
Utilitaires	Volswagen T6 2020	41â€¯250 â‚¬	191	190	6	350	1â€¯238 â‚¬	3â€¯713 â‚¬	8â€¯663 â‚¬	12â€¯375 â‚¬`;
  
  const linesArray = data.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('//'));
  let imported = 0, errors = 0, skipped = 0;
  
  console.log(`ğŸš€ DÃ©but de l'importation de ${linesArray.length} vÃ©hicules dans la deuxiÃ¨me base...\n`);
  
  for (let i = 0; i < linesArray.length; i++) {
    const line = linesArray[i];
    const parts = line.split('\t');
    
    if (parts.length < 11) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (colonnes insuffisantes: ${parts.length})`);
      skipped++;
      continue;
    }
    
    const vehicle = {
      type: parts[0]?.trim() || 'Autre',
      modele: parts[1]?.trim() || '',
      prixAchat: parseFrenchNumber(parts[2]) || 0,
      vitesseMax: parseFrenchNumber(parts[3]),
      puissance: parseFrenchNumber(parts[4]),
      nombrePlaces: parseFrenchNumber(parts[5]),
      coffre: parseFrenchNumber(parts[6]),
      assuranceTier1: parseFrenchNumber(parts[7]),
      assuranceTier2: parseFrenchNumber(parts[8]),
      assuranceTier3: parseFrenchNumber(parts[9]),
      assuranceTier4: parseFrenchNumber(parts[10]),
      achete: false,
      createdAt: serverTimestamp()
    };
    
    if (!vehicle.modele || !vehicle.prixAchat) {
      console.warn(`âš ï¸  Ligne ${i + 1} ignorÃ©e (donnÃ©es incomplÃ¨tes)`);
      skipped++;
      continue;
    }
    
    try {
      await addDoc(collection(db2, 'flotte'), vehicle);
      imported++;
      if (imported % 10 === 0 || imported === 1) {
        console.log(`âœ… [${imported}] ${vehicle.type} ${vehicle.modele}`);
      }
      if (imported % 50 === 0) {
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    } catch (error) {
      console.error(`âŒ Erreur ligne ${i + 1}: ${vehicle.modele}`, error.message || error);
      errors++;
    }
  }
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ“Š RÃ‰SUMÃ‰ DE L\'IMPORT');
  console.log('='.repeat(50));
  console.log(`âœ… ImportÃ©s: ${imported}`);
  console.log(`âŒ Erreurs: ${errors}`);
  console.log(`âš ï¸  IgnorÃ©s: ${skipped}`);
  console.log(`ğŸ“¦ Total traitÃ©: ${linesArray.length}`);
  console.log(`ğŸ—„ï¸  Base: ${window.firebaseConfig2.projectId}`);
  console.log('='.repeat(50));
})();